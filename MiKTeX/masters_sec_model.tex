\section{Моделирование паники}
\label{sec:model}

В данном разделе будет дано полное описание используемой модели паники,
начиная с требований, сформулированных на основе обзора профильной литературы,
и заканчивая конкретным математическим описанием каждой из используемых социальных сил.

\subsection{Требования к разрабатываемой модели паники}
\label{sub:model:demands}

В данном разделе на основе всех вышеописанных статей и книг будут сформулированы требования к разрабатываемой модели паники.

Следует иметь ввиду, что целью данной работы является корректировка разработанной в рамках дипломного проекта имитационной модели, что накладывает определенные ограничения на требования.
В частности, итоговая модель будет представлять собой вариацию модели социальных сил, так как именно эта модель использовалась в дипломном проекте.
Будут предложены новые социальные силы, представляющие собой некоторые отображения эффектов паники, а так же изменения ядра имитационного моделирования для лучшего представления паники.

Также модель должна в той или иной степени учитывать отличия поведения людей при панике, описанные в работе Д. Хелбинга:

\begin{itemize}
  \item люди становятся более нервными, то есть быстрее и чаще принимают необоснованные решения;
  \item люди стараются двигаться значительно быстрее чем обычно;
  \item люди начинают толкаться, взаимодействия между людьми становятся физическими по природе;
  \item движение в целом и проход через узкие места в частности становятся нескоординированными;
  \item на выходах наблюдаются скопления людей;
  \item физические взаимодействия внутри толпы складываются: суммарное давление может составлять до 4500 $\text{Н} / \text{м}^2$,
        что достаточно для разрушения кирпичных стен и повреждения стальных конструкций;
  \item движение затруднено упавшими и ранеными людьми, которые становятся <<препятствиями>>;
  \item люди демонстрируют <<стадное поведение>>, то есть делают то же, что и другие люди вокруг них;
  \item люди часто не замечают запасные выходы, запасные выходы в целом используются неэффективно.
\end{itemize}

Далее будут описаны планируемые изменения модели, позволяющие учитывать названные отличия.

Для моделирования повышенного уровня нервозности хорошо подходит социальная сила флуктуаций.
Ранее, сила флуктуаций была одномоментной "--- на каждом шаге ее значение было сгенерировано случайно.
Для представления случайных необоснованных решений, данная сила будет изменена так,
чтобы флуктуации сохраняли свое направление и силу в течении некоторого периода времени.
Подробнее данное изменение будет описано в разделе \ref{sub:model:fluctuation}.

Для учета желания двигаться значительно быстрее достаточно просто увеличить желаемую скорость,
а следовательно и модуль силы притяжения к цели.

Для моделирования физических взаимодействий внесем несколько изменений в силу отталкивания.
Во-первых, значительно снизим силу отталкивания пешеходов между собой.
Во-вторых, воспользуемся предложением, описанным в работе Simulation of pedestrian crowds in normal and evacuation situations~\cite{helbing_evacuation} "---
введем увеличенную силу отталкивания при контакте и фрикционную силу, не позволяющую двигаться в тангенциальном направлении.
Подробнее данное изменение будет описано в разделе \ref{sub:model:repulsion}.

Изменения для возникновения эффекта нескоординированности прохода через узкие места, для образования скопления людей на выходе не требуются "---
данные макроскопические эффекты должны проявиться сами.

К сожалению, моделирование давления в толпе достаточно сложная тема, и потребует чрезмерного усложнения модели для своей реализации.
По этой причине, данный эффект не будет учтен в разрабатываемой модели.
Возникновение дополнительных препятствий в виде упавших и раненых людей тоже достаточно сложно реализуемо, поэтому будет опущено по той же причине.

Для <<стадного поведения>> будет введена отдельная социальная сила, копирующая направление движения ближайших соседей.
Подробнее данное изменение будет описано в разделе \ref{sub:model:herding}.

И последняя особенность (игнорирование запасных выходов) также не будет реализована в модели по причине отсутствия целеполагания
(все промежуточные точки и цели задаются еще на этапе конфигурации).
Вместо этого, данная особенность может быть учтена вручную при помощи смены целей в конфигурации сцены.

Также модель будет предлагать несколько уникальных особенностей, не учтенных в других описанных моделях.

В частности, многие модели вводят <<уровень паники>> как параметр каждого пешехода.
Этот параметр влияет на все описанные выше эффекты "--- чем выше уровень паники, тем сильнее наблюдаемый эффект.
Однако все описанные модели определяют уровень паники как константу "--- для каждого запуска симуляции уровень паники не меняется.
В реальности же паника возникает не у всех пешеходов сразу "--- она распространяется по толпе от очага возникновения.

Таким образом, в модель будет введен <<уровень паники>> для каждого пешехода,
однако он будет меняться в зависимости от уровня паники окружающих пешехода людей.
Подробнее данное изменение будет описано в разделе \ref{sub:model:panic_level}.

\subsection{Изменения в силе флуктуации}
\label{sub:model:fluctuation}

Как уже было отмечено, ранее сила флуктуации в каждый момент времени определялась как сила в случайном направлении со случайным модулем.
Для моделирования случайных иррациональных решений пешехода изменим данную силу так, чтобы она представляла некоторую случайную цель.

Определим силу флуктуации как силу, возникающую с определенной вероятностью на случайный промежуток времени,
и имеющую постоянное направление и модуль в течении этого промежутка времени.
Изначальные направление и модуль генерируются случайно в момент возникновения флуктуации.

При этом все параметры данной силы (вероятность возникновения, случайный промежуток времени действия, случайный модуль) зависят от текущего уровня паники.
Чем выше уровень паники, тем чаще флуктуации будут возникать, тем дольше они будут действовать и тем сильнее они будут.

\subsection{Изменения в силе отталкивания}
\label{sub:model:repulsion}

Напомним, что в изначальной модели сила отталкивания определялась как:

\begin{equation}
  \label{sub:model:repulstion:force_fm}
  \vec{F}_{\alpha\beta}^{repulsion}(\vec{r}_{\alpha\beta}) = - \nabla V(r_{\alpha\beta})
\end{equation}
\begin{explanation}
где & $ r_{\alpha\beta} = r_\alpha - r_\beta $ & вектор направления от $\beta$ к ближайшей точке $\alpha$; \\
    & $ V(r_{\alpha\beta}) $ & функция, эквипотенциальные линии которой имеют форму эллипса, вытянутого по направлению движения $\vec{v}_\alpha$.
\end{explanation}

Заметим, что изначальная функция отталкивания не зависела от типа препятствия.
Теперь же нам нужно иметь разную силу отталкивания от элементов конструкции (стен) и от других пешеходов.

Силу отталкивания от стен оставим без семантических изменений, лишь развернем определение функции $\nabla V$:

\begin{equation}
  \label{sub:model:repulstion:force_walls_fm}
  \vec{F}_{\alpha\beta}^{wall}(\vec{r}_{\alpha\beta}) = A exp( \frac{rad_{person} - ||\vec{r}_{\alpha\beta}||}{B} ) \frac{\vec{r}_{\alpha\beta}}{||\vec{r}_{\alpha\beta}||}
  (K + (1 - K)\frac{1 + cos(\phi_{\alpha\beta})}{2})
\end{equation}
\begin{explanation}
где & $ \vec{r}_{\alpha\beta} = r_\alpha - r_\beta $ & вектор направления от $\beta$ к ближайшей точке $\alpha$; \\
    & $ ||\vec{r}_{\alpha\beta}|| $ & дистанция от $\alpha$ до $\beta$; \\
    & $ rad_{person} $ & средний радиус пешехода; \\
    & $ A $ & коэффициент, задающий максимальную силу отталкивания; \\
    & $ B $ & коэффициент, задающий расстояние, на котором работает сила отталкивания (при $||\vec{r}_{\alpha\beta}|| = B$ сила отталкивания равна $0.36A$, при $||\vec{r}_{\alpha\beta}|| = 2B$ сила отталкивания равна $0.13A$ ); \\
    & $ \frac{\vec{r}_{\alpha\beta}}{||\vec{r}_{\alpha\beta}||} $ & нормированный вектор от $\beta$ к $\alpha$; \\
    & $ K $ & коэффициент, задающий анизотропность силы отталкивания; \\
    & $ \phi_{\alpha\beta} $ & угол между направлением движения $\vec{v}_\alpha$ и направлением к препятствию $\vec{r}_{\alpha\beta}$. \\
\end{explanation}

Базовую силу отталкивания от других пешеходов выразим аналогично силе отталкивания от стен:

\begin{equation}
  \label{sub:model:repulstion:force_pedestr_dist_fm}
  \begin{aligned}
    & \vec{F}_{\alpha\beta}^{pedestrian\ basic}(\vec{r}_{\alpha\beta}) & = A (1 - pl_\alpha) exp( \frac{2 * rad_{person} - ||\vec{r}_{\alpha\beta}||}{B} ) \\
    &                                                                             & \frac{\vec{r}_{\alpha\beta}}{||\vec{r}_{\alpha\beta}||} (K + (1 - K)\frac{1 + cos(\phi_{\alpha\beta})}{2})
  \end{aligned}
\end{equation}
\begin{explanation}
где & $ pl_\alpha $ & уровень паники пешехода $\alpha$. \\
\end{explanation}

Таким образом, при возрастании уровня паники сила отталкивания между пешеходами будет уменьшаться.

Введем новую силу отталкивания, действующую при физическом контакте:

\begin{equation}
  \label{sub:model:repulstion:force_pedestr_phys_fm}
  \vec{F}_{\alpha\beta}^{pedestrian\ phys}(\vec{r}_{\alpha\beta}) = k_{phys} (2 * rad_{person} - ||\vec{r}_{\alpha\beta}||) \frac{\vec{r}_{\alpha\beta}}{||\vec{r}_{\alpha\beta}||}
\end{equation}
\begin{explanation}
где & $ k_{phys} $ & большой коэффициент физического отталкивания. \\
\end{explanation}

И еще одну силу, препятствующую тангенциальному движению при физическом контакте:

\begin{equation}
  \label{sub:model:repulstion:force_pedestr_tangent_fm}
  \vec{F}_{\alpha\beta}^{pedestrian\ tangent}(\vec{r}_{\alpha\beta}) = k_{tangent} (2 * rad_{person} - ||\vec{r}_{\alpha\beta}||) \Delta v_{\beta\alpha}^t \vec{t}_{\alpha\beta}
\end{equation}
\begin{explanation}
где & $ k_{tangent} $ & большой коэффициент сопротивления тангенциальному движению; \\
    & $ \vec{t}_{\alpha\beta} $ & тангенциальное направление по отношению к направлению от $\beta$ к $\alpha$, получается разворотом вектора $ \frac{\vec{r}_{\alpha\beta}}{||\vec{r}_{\alpha\beta}||} $ на 90 градусов против часовой стрелки; \\
    & $ \Delta v_{\beta\alpha}^t = (\vec{v}_\beta - \vec{v}_\alpha) \vec{t}_{\alpha\beta} $ & проекция разницы скоростей $\beta$ и $\alpha$ на тангенциальное направление; \\
\end{explanation}

Итоговая сила отталкивания от пешехода определяется как:

\begin{equation}
  \label{sub:model:repulstion:force_pedestr_fm}
  \vec{F}_{\alpha\beta}^{pedestrian}(\vec{r}_{\alpha\beta}) =
    \begin{cases}
      \vec{F}_{\alpha\beta}^{pedestrian\ basic}(\vec{r}_{\alpha\beta}), & \text{если}\ ||\vec{r}_{\alpha\beta}|| > 2 * rad_{person} \\
      \vec{F}_{\alpha\beta}^{pedestrian\ phys}(\vec{r}_{\alpha\beta}) + & \\
      \vec{F}_{\alpha\beta}^{pedestrian\ tangent}(\vec{r}_{\alpha\beta}), & \text{иначе} \\
    \end{cases}
\end{equation}

А итоговая сила отталкивания как:

\begin{equation}
  \label{sub:model:repulstion:force_pedestr_fm}
  \vec{F}_\alpha^{repulsion} = \sum\limits_{\beta=walls} \vec{F}_{\alpha\beta}^{wall}(\vec{r}_{\alpha\beta}) + \\
                        \sum\limits_{\beta=pedestrians} \vec{F}_{\alpha\beta}^{pedestrian}(\vec{r}_{\alpha\beta})
\end{equation}

\subsection{Новая сила <<стадного поведения>>}
\label{sub:model:herding}

Новая сила <<стадного поведения>> призвана учесть тенденцию людей следовать за другими людьми в критических ситуациях.

Математически данную силу можно выразить как

\begin{equation}
  \label{sub:model:repulstion:force_pedestr_fm}
  \vec{F}_\alpha^{herding} = pl_\alpha \sum\limits_{\beta=pedestrians} \vec{v}_\beta
\end{equation}
\begin{explanation}
где & $ pl_\alpha $ & уровень паники пешехода $\alpha$; \\
    & $ pedestrians $ & все другие пешеходы в области видимости; \\
    & $ \vec{v}_\beta  $ & направление движения пешехода $\beta$.
\end{explanation}

Несмотря на кажущуюся простоту, можно заметить, что данная функция по своей сути рекурсивна.
Изменение направления движения одного пешехода может вызвать изменение направления движения других пешеходов,
имеющих первого пешехода в области видимости.

В общем случае, данный рекурсивный процесс может не сходится к определенному результату.
Поэтому, а так же по соображениям производительности, рекомендуется брать в качестве направления движения пешехода не текущее направление,
а направление движения на предыдущем шаге.
Таким образом рекурсия будет перенесена (<<размазана>>) во времени, не будет иметь негативных последствий для производительности,
но при этом сохранит все нужные для моделирования свойства.

\subsection{Уровень паники и его распространение}
\label{sub:model:panic_level}

В предыдущих разделах уже упоминался уровень паники каждого пешехода $pl_\alpha$.
Это число от нуля до единицы представляющее собой степень проявления эффектов паники.
Соответственно, при значении ноль эффекты паники отсутствуют, а при значении один эффекты паники проявляются сильней всего.

Как уже сообщалось ранее, большинство моделей считают уровень паники каждого пешехода константой в рамках одной симуляции.
В данном разделе будет предложена модель распространения паники.

Разрабатываемая модель предполагает наличие источников паники, а так же распространение паники среди людей в области видимости.
Источниками паники являются какие-либо опасные объекты.


Определим уровень паники на шаге $t$ как
\begin{equation}
  \label{sec:model:sf:panic:level}
  pl_\alpha^t = kspl {{1}\over{n}} \sum\limits_{i=1}^n {pl_i} + kipl {{1}\over{m}} \sum\limits_{i=1}^m {opl_i}
\end{equation}
\begin{explanation}
где & $ kspl $ & коэффициент распространения паники; \\
    & $ kipl $ & коэффициент начального приобретения паники; \\
    & $ pl_i $ & уровень паники $i$-ого пешехода; \\
    & $ opl_i $ & уровень паники $i$-ого опасного объекта; \\
    & $ n $ & количество других пешеходов в поле зрения пешехода; \\
    & $ m $ & количество опасных объектов в поле зрения пешехода; \\
\end{explanation}

Если бы мы определили итоговый уровень паники как уровень паники на шаге $t$,
то уровень паники естественно затухал бы при отдалении от опасных объектов.
В реальности же эффект паники не пропадает просто так "--- для этого нужно время.
Чтобы учесть данную закономерность, определим уровень паники на шаге $t + 1$ как:

\begin{equation}
  \label{sec:model:sf:panic:level}
  pl_\alpha^{t + 1} =
    \begin{cases}
      pl_\alpha^t, &\text{если} pl_\alpha^t > pl_\alpha \\
      kdpl (pl_\alpha - pl_\alpha^t), &\text{иначе} \\
    \end{cases}
\end{equation}
\begin{explanation}
где & $ kdpl $ & коэффициент затухания уровня паники. \\
\end{explanation}


Следует отметить важность выбора коэффициента распространения паники $kspl$ и коэффициента затухания паники $kdpl$.
Если установить для данных коэффициентов слишком низкое значение, то эффект лавинообразного возникновения паники не появится.
Если же установить слишком высокое значение, то пешеходы могут войти в состояние паники даже от незначительных воздействий.
